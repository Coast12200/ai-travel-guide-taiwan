<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ æ—…äººæ¢ç´¢æœ­è¨˜ - AI æ™ºæ…§å°è¦½</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/print.css">
    <link rel="stylesheet" href="css/fix-map.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/smart-planner.css">
    <link rel="stylesheet" href="css/itinerary-buttons.css">
    <link rel="stylesheet" href="css/travel-journal.css">
    <link rel="stylesheet" href="css/version-history.css">
    <link rel="stylesheet" href="css/header-enhanced.css">
    <link rel="stylesheet" href="css/download-progress.css">
    <link rel="stylesheet" href="css/mobile-scroll-fix.css">
    <link rel="stylesheet" href="css/itinerary-ui-enhanced.css">
    <link rel="stylesheet" href="css/api-settings-enhanced.css">
    <link rel="stylesheet" href="css/bottom-sheet-enhanced.css">
    <link rel="stylesheet" href="css/country-selection-enhanced.css">
    <link rel="stylesheet" href="css/search-enhanced.css">
</head>

<body>
    <!-- æ–°å¢ï¼šéª¨æ¶è¼‰å…¥ç•«é¢ -->
    <div id="loading-skeleton">
        <div class="skeleton-header">
            <div class="skeleton-title skeleton"></div>
            <div class="skeleton-subtitle skeleton"></div>
        </div>
        <div class="skeleton-panel">
            <div class="skeleton-line skeleton"></div>
            <div class="skeleton-line skeleton"></div>
        </div>
        <div class="skeleton-panel">
            <div class="skeleton-tabs">
                <div class="skeleton-tab skeleton"></div>
                <div class="skeleton-tab skeleton"></div>
            </div>
            <div class="skeleton-cards">
                <div class="skeleton-card">
                    <div class="skeleton-card-icon skeleton"></div>
                    <div class="skeleton-card-text">
                        <div class="skeleton-line skeleton"></div>
                        <div class="skeleton-line skeleton"></div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton-card-icon skeleton"></div>
                    <div class="skeleton-card-text">
                        <div class="skeleton-line skeleton"></div>
                        <div class="skeleton-line skeleton"></div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton-card-icon skeleton"></div>
                    <div class="skeleton-card-text">
                        <div class="skeleton-line skeleton"></div>
                        <div class="skeleton-line skeleton"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container hidden">
        <header class="header fade-in">
            <!-- æ¨™é¡Œå€åŸŸ -->
            <div class="header-title">
                <h1 data-i18n="title">æ—…äººæ¢ç´¢æœ­è¨˜</h1>
                <p class="subtitle" data-i18n="subtitle">AI æ™ºæ…§å°è¦½ï¼Œç‚ºæ‚¨çš„æ—…ç¨‹å¢æ·»éˆæ„Ÿèˆ‡æ•…äº‹</p>
            </div>

            <!-- æ§åˆ¶æŒ‰éˆ•å€åŸŸ -->
            <div class="header-controls">
                <!-- ä¸»è¦åŠŸèƒ½ï¼ˆå·¦å´ï¼‰ -->
                <div class="controls-primary">
                    <button id="favoritesToggleBtn" class="btn btn-header" data-i18n="favorites">
                        <span class="btn-icon">â¤ï¸</span>
                        <span class="btn-text">æˆ‘çš„æ”¶è—</span>
                    </button>
                    <button id="themeToggleBtn" class="btn btn-header" data-i18n="theme_night">
                        <span class="btn-icon">ğŸŒ™</span>
                        <span class="btn-text">å¤œé–“æ¨¡å¼</span>
                    </button>
                    <button id="langToggleBtn" class="btn btn-header">
                        <span class="btn-icon">ğŸŒ</span>
                        <span class="btn-text">EN</span>
                    </button>
                </div>

                <!-- æ¬¡è¦åŠŸèƒ½ï¼ˆå³å´ï¼‰ -->
                <div class="controls-secondary">
                    <div class="dropdown">
                        <button class="btn btn-header dropdown-toggle" id="advancedSettingsBtn">
                            <span class="btn-icon">âš™ï¸</span>
                            <span class="btn-text">é€²éšè¨­å®š</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div class="dropdown-menu hidden" id="advancedSettingsMenu">
                            <label class="dropdown-item">
                                <input type="checkbox" id="alwaysOfflineToggle" aria-label="Always offline mode" />
                                <span data-i18n="always_offline_label" id="alwaysOfflineLabel"
                                    title="å•Ÿç”¨å¾Œå°‡å¼·åˆ¶ä½¿ç”¨é›¢ç·šå‚™æ´è³‡æ–™ï¼Œé¿å…å‘ TDX ç™¼å‡ºè«‹æ±‚">
                                    å§‹çµ‚é›¢ç·šæ¨¡å¼
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤©æ°£è­¦å ±æ©«å¹… -->
            <div id="weatherAlertBanner" class="weather-alert hidden" role="status" aria-live="polite">
                <div id="weatherAlertIcon" style="font-size:1.2rem;"></div>
                <div id="weatherAlertText" style="flex:1; font-weight:600;"></div>
                <button id="dismissWeatherAlertBtn" class="btn" title="é—œé–‰è­¦ç¤º">âœ•</button>
            </div>
        </header>
        <!-- Toast container -->
        <div id="toastContainer" aria-live="polite" style="position: fixed; right: 20px; bottom: 20px; z-index: 2000;">
        </div>

        <!-- æˆ‘çš„æ”¶è— Modal -->
        <div id="favoritesModal" class="modal-overlay hidden">
            <div class="modal-content">
                <button id="closeFavoritesModalBtn" class="modal-close-btn">&times;</button>
                <h3>â¤ï¸ æˆ‘çš„æ”¶è—</h3>
                <div id="favoritesList">
                    <p>å°šæœªæ”¶è—ä»»ä½•æ™¯é»ã€‚</p>
                </div>
            </div>
        </div>

        <!-- Onboarding Modal -->
        <div id="onboardingModal" class="modal-overlay hidden" aria-hidden="true">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="onboardTitle">
                <button id="closeOnboardingBtn" class="modal-close-btn">&times;</button>
                <h3 id="onboardTitle">å¿«é€Ÿä¸Šæ‰‹å°å¼•</h3>
                <div id="onboardSteps" style="min-height:140px;">
                    <!-- Steps will be injected by JS -->
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                    <button id="onboardPrevBtn" class="btn">ä¸Šä¸€æ­¥</button>
                    <button id="onboardNextBtn" class="btn c-btn--primary">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>

        <!-- Diagnostics Modal -->
        <div id="diagnosticsModal" class="modal-overlay hidden" aria-hidden="true">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="diagnosticsTitle">
                <button id="closeDiagnosticsBtn" class="modal-close-btn">&times;</button>
                <h3 id="diagnosticsTitle">Diagnostics / è¨ºæ–·å ±å‘Š</h3>
                <div id="diagnosticsContent" style="min-height:120px; font-size:0.95rem; color:var(--dark-text);"></div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                    <button id="copyDiagnosticsBtn" class="btn">Copy JSON</button>
                    <button id="exportDiagnosticsBtn" class="btn c-btn--primary">Export</button>
                </div>
            </div>
        </div>

        <section class="steps-guide fade-in" style="--animation-delay: 0.1s;">
            <div class="step" data-i18n="step1">â‘  è¼¸å…¥ API é‡‘é‘°</div>
            <div class="step" data-i18n="step2">â‘¡ é¸æ“‡æ¢ç´¢åœ‹åº¦</div>
            <div class="step" data-i18n="step3">â‘¢ é»é¸å–œæ„›æ™¯é»</div>
            <div class="step" data-i18n="step4">â‘£ é–‹å§‹ AI äº’å‹•</div>
        </section>

        <section class="panel api-config fade-in" style="--animation-delay: 0.2s;">
            <h3 data-i18n="api_keys_title">ğŸ”‘ API é‡‘é‘°è¨­å®š</h3>
            <!-- å¿…éœ€ API -->
            <div class="api-section required-section">
                <div class="section-header">
                    <h4>
                        <span class="badge badge-required">å¿…éœ€</span>
                        æ ¸å¿ƒ AI åŠŸèƒ½
                    </h4>
                    <p class="section-desc">ä»¥ä¸‹ API ç‚ºå¿…éœ€ï¼Œç”¨æ–¼ AI è¡Œç¨‹è¦åŠƒ</p>
                </div>
                <div class="api-card">
                    <div class="api-card-header">
                        <div class="api-icon">ğŸ¤–</div>
                        <div class="api-info">
                            <h5>Google Gemini API</h5>
                            <p>AI æ™ºæ…§è¡Œç¨‹ç”Ÿæˆå¼•æ“</p>
                        </div>
                        <div class="api-status" id="geminiStatus">
                            <span class="status-badge status-pending">æœªé©—è­‰</span>
                        </div>
                    </div>
                    <div class="api-card-body">
                        <div class="input-with-action">
                            <div class="input-wrapper">
                                <input type="password" id="geminiApiKey" class="api-input enhanced"
                                    placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Gemini API Key" autocomplete="off">
                                <button class="input-toggle-btn" id="toggleGeminiKey" type="button"
                                    title="é¡¯ç¤º/éš±è— API Key">
                                    <span class="show-icon">ğŸ‘ï¸</span>
                                    <span class="hide-icon" style="display:none;">ğŸ™ˆ</span>
                                </button>
                            </div>
                            <button class="btn btn-verify" id="verifyGeminiBtn" data-i18n="verify_gemini">
                                <span class="btn-icon">âœ“</span>
                                <span class="btn-text">é©—è­‰</span>
                            </button>
                        </div>
                        <div class="api-help">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="help-link">
                                <span class="link-icon">ğŸ”—</span>
                                <span>å‰å¾€ Google AI Studio ç”³è«‹å…è²» Key</span>
                                <span class="external-icon">â†—</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- å¯é¸ API -->
            <div class="api-section optional-section">
                <div class="section-header">
                    <h4>
                        <span class="badge badge-optional">å¯é¸</span>
                        å¢å¼·åŠŸèƒ½
                    </h4>
                    <p class="section-desc">ä»¥ä¸‹ API ç‚ºå¯é¸ï¼Œç”¨æ–¼å¤©æ°£é å ±å’Œæ™¯é»è³‡è¨Š</p>
                </div>
                <!-- CWA API Card -->
                <div class="api-card">
                    <div class="api-card-header">
                        <div class="api-icon">ğŸŒ¤ï¸</div>
                        <div class="api-info">
                            <h5>ä¸­å¤®æ°£è±¡ç½² API</h5>
                            <p>å³æ™‚å¤©æ°£é å ±èˆ‡è­¦å ±ï¼ˆåƒ…é™å°ç£ï¼‰</p>
                        </div>
                        <div class="api-status" id="cwaStatus">
                            <span class="status-badge status-optional">å¯é¸</span>
                        </div>
                    </div>
                    <div class="api-card-body">
                        <div class="input-with-action">
                            <div class="input-wrapper">
                                <input type="password" id="cwaApiKey" class="api-input enhanced"
                                    placeholder="è«‹è²¼ä¸Š CWA API Keyï¼ˆé¸å¡«ï¼‰" autocomplete="off">
                                <button class="input-toggle-btn" id="toggleCwaKey" type="button" title="é¡¯ç¤º/éš±è— API Key">
                                    <span class="show-icon">ğŸ‘ï¸</span>
                                    <span class="hide-icon" style="display:none;">ğŸ™ˆ</span>
                                </button>
                            </div>
                            <button class="btn btn-verify" id="verifyCwaBtn" data-i18n="verify_cwa">
                                <span class="btn-icon">âœ“</span>
                                <span class="btn-text">è¼‰å…¥å¤©æ°£</span>
                            </button>
                        </div>
                        <div class="api-help">
                            <a href="https://opendata.cwa.gov.tw/user/authkey" target="_blank" class="help-link">
                                <span class="link-icon">ğŸ”—</span>
                                <span>å‰å¾€ä¸­å¤®æ°£è±¡ç½²å¹³å°ç”³è«‹å…è²» Key</span>
                                <span class="external-icon">â†—</span>
                            </a>
                        </div>
                    </div>
                </div>
                <!-- TDX API Card -->
                <div class="api-card">
                    <div class="api-card-header">
                        <div class="api-icon">ğŸš‡</div>
                        <div class="api-info">
                            <h5>TDX é‹è¼¸è³‡æ–™ API</h5>
                            <p>æ™¯é»è³‡è¨Šèˆ‡äº¤é€šæ•¸æ“š</p>
                        </div>
                        <div class="api-status" id="tdxStatus">
                            <span class="status-badge status-optional">å¯é¸</span>
                        </div>
                    </div>
                    <div class="api-card-body">
                        <div class="input-row">
                            <div class="input-wrapper">
                                <input type="password" id="tdxClientId" class="api-input enhanced"
                                    placeholder="TDX Client IDï¼ˆé¸å¡«ï¼‰" autocomplete="off">
                                <button class="input-toggle-btn" id="toggleTdxClientId" type="button"
                                    title="é¡¯ç¤º/éš±è— Client ID">
                                    <span class="show-icon">ğŸ‘ï¸</span>
                                    <span class="hide-icon" style="display:none;">ğŸ™ˆ</span>
                                </button>
                            </div>
                            <div class="input-wrapper">
                                <input type="password" id="tdxClientSecret" class="api-input enhanced"
                                    placeholder="TDX Client Secretï¼ˆé¸å¡«ï¼‰" autocomplete="off">
                                <button class="input-toggle-btn" id="toggleTdxSecret" type="button"
                                    title="é¡¯ç¤º/éš±è— Client Secret">
                                    <span class="show-icon">ğŸ‘ï¸</span>
                                    <span class="hide-icon" style="display:none;">ğŸ™ˆ</span>
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-verify btn-full-width" id="verifyTdxBtn" data-i18n="verify_tdx">
                                <span class="btn-icon">âœ“</span>
                                <span class="btn-text">é©—è­‰ TDX</span>
                            </button>
                            <button class="btn btn-secondary" id="forceRefreshBtn" title="æ¸…é™¤ TDX å¿«å–ä¸¦é‡æ–°è¼‰å…¥å³æ™‚è³‡æ–™">
                                <span>ğŸ”„</span>
                                <span>Force refresh</span>
                            </button>
                        </div>
                        <div class="api-help">
                            <a href="https://tdx.transportdata.tw/user/register" target="_blank" class="help-link">
                                <span class="link-icon">ğŸ”—</span>
                                <span>å‰å¾€ TDX é‹è¼¸è³‡æ–™å¹³å°ç”³è«‹å…è²» Key</span>
                                <span class="external-icon">â†—</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- è¨ºæ–·å·¥å…· -->
            <div class="api-tools">
                <button class="btn btn-secondary btn-sm" id="showDiagnosticsBtn">
                    <span>ğŸ”</span>
                    <span>é¡¯ç¤ºè¨ºæ–·å ±å‘Š</span>
                </button>
            </div>
            <div id="apiStatus" class="api-status hidden"></div>
        </section>

        <section class="panel country-selector fade-in" style="--animation-delay: 0.3s;">
            <!-- å„ªåŒ–çš„æ¨™é¡Œå€åŸŸ -->
            <div class="panel-header-enhanced">
                <div class="header-title-group">
                    <h3 data-i18n="country_selector_title">ğŸŒ é¸æ“‡æ¢ç´¢åœ‹åº¦</h3>
                    <p class="header-subtitle">æ¢ç´¢å°ç£å„åœ°ç¾æ™¯ï¼Œè¦åŠƒæ‚¨çš„å®Œç¾æ—…ç¨‹</p>
                </div>
                <div class="header-actions">
                    <div class="search-container">
                        <input type="text" id="destinationSearch" class="api-input"
                            data-i18n-placeholder="search_placeholder" placeholder="ğŸ” æœå°‹æ™¯é»åç¨±æˆ–åŸå¸‚...">
                        <button id="searchClearBtn" type="button" class="search-clear-btn" title="æ¸…é™¤æœå°‹"
                            style="display:none;">âœ•</button>
                    </div>
                    <button id="addCustomSpotBtn" type="button" class="btn btn-primary"
                        data-i18n="add_custom_spot_title">
                        <span class="btn-icon">+</span>
                        <span class="btn-text">æ–°å¢è‡ªè¨‚æ™¯é»</span>
                    </button>
                </div>
            </div>
            <!-- åœ‹å®¶æ¨™ç±¤ -->
            <div class="country-tabs-enhanced" id="countryTabs"></div>
        </section>

        <section class="destinations" id="destinations"></section>
        <!-- æœå°‹ç„¡çµæœæç¤º -->
        <div id="searchNoResults" class="search-no-results" style="display:none;">
            <div class="no-results-icon">ğŸ”</div>
            <p data-i18n="search_no_results">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ™¯é»</p>
            <small data-i18n="search_no_results_hint">è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–æ¸…é™¤æœå°‹</small>
        </div>


        <section class="panel weather-suggestion-panel fade-in hidden" id="weatherSuggestionPanel"
            style="--animation-delay: 0.4s;">
            <h3 data-i18n="ai_planner_title">ğŸ’¡ AI è¡Œç¨‹è¦åŠƒå¸«</h3>

            <!-- å¿«é€Ÿé–‹å§‹å€å¡Š -->
            <div class="quick-start-section">
                <!-- å–œå¥½è¼¸å…¥ -->
                <div class="preference-input-group">
                    <input type="text" id="itineraryPrefs" class="api-input preference-input"
                        placeholder="æ‚¨æƒ³è¦ä»€éº¼æ¨£çš„æ—…ç¨‹ï¼Ÿ(ä¾‹å¦‚: è¦ªå­å‹å–„ã€ç¾é£Ÿæ¢ç´¢ã€æ–‡é’æ…¢æ´»...)">
                    <button id="voiceInputBtn" class="btn voice-btn" title="èªéŸ³è¼¸å…¥">ğŸ¤</button>
                </div>
                <span id="voiceStatus" style="font-size:0.9rem; color:var(--muted); display:none;">Listening...</span>

                <!-- åŸºæœ¬è³‡è¨Šå–®è¡Œ -->
                <div class="basic-info-row">
                    <div class="info-item">
                        <label>ğŸ“ ç›®çš„åœ°</label>
                        <select id="destinationSelect" class="api-input compact">
                            <option value="taiwan">å°ç£</option>
                        </select>
                    </div>

                    <div class="info-item">
                        <label>ğŸ‘¥ äººæ•¸</label>
                        <input type="number" id="groupSizeInput" class="api-input compact" min="1" value="2">
                    </div>

                    <div class="info-item">
                        <label>ğŸ“… æ—¥æœŸ</label>
                        <input type="date" id="itineraryDate" class="api-input compact">
                    </div>

                    <div class="info-item">
                        <label>ğŸ• æ™‚é•·</label>
                        <select id="durationTypeSelect" class="api-input compact">
                            <option value="single">å–®æ—¥éŠ</option>
                            <option value="multi">å¤šæ—¥éŠ</option>
                        </select>
                    </div>
                </div>

                <!-- ä¸»è¦è¡Œç¨‹é¡å‹æŒ‰éˆ• -->
                <div class="suggestion-controls-enhanced">
                    <button class="suggestion-btn-enhanced sunny-enhanced" id="sunnyBtn">
                        <span class="btn-icon">â˜€ï¸</span>
                        <span class="btn-text">
                            <strong>æ™´å¤©æ¼«éŠ</strong>
                            <small>æˆ¶å¤–æ™¯é» Â· é™½å…‰æ˜åªš</small>
                        </span>
                    </button>

                    <button class="suggestion-btn-enhanced rainy-enhanced" id="rainyBtn">
                        <span class="btn-icon">ğŸŒ§ï¸</span>
                        <span class="btn-text">
                            <strong>é›¨å¤©å‚™æ¡ˆ</strong>
                            <small>å®¤å…§æ´»å‹• Â· é¿é›¨å¥½å»è™•</small>
                        </span>
                    </button>

                    <button class="suggestion-btn-enhanced lucky-enhanced" id="luckyBtn">
                        <span class="btn-icon">ğŸ”®</span>
                        <span class="btn-text">
                            <strong>éš¨æ©Ÿæ¢ç´¢</strong>
                            <small>AI æŒ‘é¸ Â· é©šå–œæ™¯é»</small>
                        </span>
                    </button>

                    <button class="suggestion-btn-enhanced multi-enhanced" id="multiDayBtn">
                        <span class="btn-icon">ğŸ“…</span>
                        <span class="btn-text">
                            <strong>å¤šæ—¥è¡Œç¨‹</strong>
                            <small>æ·±åº¦æ—…éŠ Â· 2-7å¤©</small>
                        </span>
                    </button>
                </div>
            </div>
            <!-- è¡Œç¨‹æ“ä½œæŒ‰éˆ• -->
            <!-- æ›´å¤šè¨­å®šæ‘ºç–Šå€å¡Š -->
            <div class="more-settings-section">
                <button class="more-settings-toggle" id="moreSettingsToggle" type="button" aria-expanded="false">
                    <span class="toggle-text">âš™ï¸ æ›´å¤šè¨­å®š</span>
                    <span class="toggle-icon">â–¼</span>
                </button>

                <div class="more-settings-content" id="moreSettingsContent">
                    <!-- æ™‚é–“è¨­å®š (åƒ…å–®æ—¥éŠé¡¯ç¤º) -->
                    <div class="settings-group time-settings" id="timeSettingsGroup">
                        <h4 class="settings-group-title">ğŸ• æ™‚é–“å®‰æ’</h4>
                        <div class="settings-row">
                            <div class="setting-item">
                                <label>é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="itineraryStartTime" class="api-input" value="09:00">
                            </div>
                            <div class="setting-item">
                                <label>çµæŸæ™‚é–“</label>
                                <input type="time" id="itineraryEndTime" class="api-input" value="18:00">
                            </div>
                        </div>
                        <small class="hint-text">æˆ–ç›´æ¥è¼¸å…¥ç¸½æ™‚é•· (ä¾‹å¦‚: 6å°æ™‚)</small>
                    </div>

                    <!-- å¤šæ—¥éŠå¤©æ•¸ (åƒ…å¤šæ—¥éŠé¡¯ç¤º) -->
                    <div class="settings-group multi-day-settings" id="multiDaySettingsGroup" style="display:none;">
                        <h4 class="settings-group-title">ğŸ“… è¡Œç¨‹å¤©æ•¸</h4>
                        <div class="settings-row">
                            <div class="setting-item">
                                <label>å¤©æ•¸</label>
                                <input type="number" id="tripDaysInput" class="api-input" min="1" max="7" value="3">
                            </div>
                        </div>
                    </div>

                    <!-- åœ˜é«”æˆå“¡ -->
                    <div class="settings-group">
                        <h4 class="settings-group-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ åœ˜é«”æˆå“¡</h4>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="groupHasChildren">
                                <span>æœ‰å°å­©</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="groupHasSeniors">
                                <span>æœ‰é•·è€…</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="groupVegetarian">
                                <span>ç´ é£Ÿè€…</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="groupWheelchair">
                                <span>ç„¡éšœç¤™éœ€æ±‚</span>
                            </label>
                        </div>
                    </div>

                    <!-- é ç®—èˆ‡é¤é£² -->
                    <div class="settings-group">
                        <h4 class="settings-group-title">ğŸ’° é ç®— & ğŸ½ï¸ é¤é£²</h4>
                        <div class="settings-row">
                            <div class="setting-item">
                                <label>é ç®—ç­‰ç´š</label>
                                <select id="budgetLevelSelect" class="api-input">
                                    <option value="budget">ğŸ’µ ç¯€å„‰ (NT$800-1,500/å¤©)</option>
                                    <option value="comfort" selected>ğŸ’´ èˆ’é© (NT$1,500-3,000/å¤©)</option>
                                    <option value="luxury">ğŸ’ è±ªè¯ (NT$3,000-5,000/å¤©)</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>é¤é£²åå¥½</label>
                                <select id="diningPreferenceSelect" class="api-input">
                                    <option value="local-street" selected>ğŸœ ç•¶åœ°å°åƒ (å¹³åƒ¹)</option>
                                    <option value="casual-restaurant">ğŸ± æ™®é€šé¤å»³ (ä¸­ç­‰)</option>
                                    <option value="fine-dining">ğŸ· é«˜æª”é¤å»³ (å¥¢è¯)</option>
                                    <option value="mixed">ğŸ½ï¸ æ··åˆæ­é…</option>
                                </select>
                            </div>
                        </div>
                        <!-- ä¼°ç®—æŒ‰éˆ• -->
                        <div class="settings-row" style="margin-top: 12px;">
                            <div class="setting-item" style="grid-column: 1 / -1;">
                                <button id="estimateBudgetBtn" class="btn" style="width: 100%; padding: 12px;">
                                    ğŸ’° ä¼°ç®—æ—…è²»
                                </button>
                                <small class="hint-text" style="margin-top: 8px;">
                                    æ ¹æ“šæ‚¨çš„é ç®—ç­‰ç´šã€é¤é£²åå¥½å’Œè¡Œç¨‹å¤©æ•¸ï¼ŒAI å°‡ç‚ºæ‚¨ä¼°ç®—è©³ç´°çš„æ—…è²»åˆ†é…ã€‚
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤é€šèˆ‡é¢¨æ ¼ -->
                    <div class="settings-group">
                        <h4 class="settings-group-title">ğŸš— äº¤é€š & âœ¨ é¢¨æ ¼</h4>
                        <div class="settings-row">
                            <div class="setting-item">
                                <label>äº¤é€šæ–¹å¼</label>
                                <select id="transportModeSelect" class="api-input">
                                    <option value="driving">ğŸš— ç§å®¶è»Š / é§•è»Š</option>
                                    <option value="public">ğŸšŒ å¤§çœ¾é‹è¼¸</option>
                                    <option value="walking">ğŸš¶ æ­¥è¡Œ</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>æ—…è¡Œé¢¨æ ¼</label>
                                <select id="itineraryStyleSelect" class="api-input">
                                    <option value="">â€” é¸æ“‡é¢¨æ ¼ â€”</option>
                                    <option value="æ–‡é’æ…¢æ´»">ğŸ“š æ–‡é’æ…¢æ´»</option>
                                    <option value="æ¥µé™æŒ‘æˆ°">ğŸ”ï¸ æ¥µé™æŒ‘æˆ°</option>
                                    <option value="ç¾é£Ÿæ¢ç´¢">ğŸ´ ç¾é£Ÿæ¢ç´¢</option>
                                    <option value="è¦ªå­å‹å–„">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ è¦ªå­å‹å–„</option>
                                    <option value="è‡ªç„¶ç”Ÿæ…‹">ğŸŒ¿ è‡ªç„¶ç”Ÿæ…‹</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- åœ–ç‰‡ä¸Šå‚³ -->
                    <div class="settings-group">
                        <h4 class="settings-group-title">ğŸ“· è¦–è¦ºåƒè€ƒ (å¯é¸)</h4>
                        <div class="image-upload-compact">
                            <input type="file" id="aiImageUpload" accept="image/*" class="api-input">
                            <div class="upload-actions">
                                <button id="attachImageBtn" class="btn btn-sm">é™„åŠ åˆ° AI</button>
                                <button id="clearImageBtn" class="btn btn-sm">æ¸…é™¤</button>
                            </div>
                        </div>
                        <div id="aiImagePreviewWrapper" class="image-preview-compact" style="display:none;">
                            <img id="aiImagePreview" alt="é è¦½">
                            <small id="aiImagePreviewInfo"></small>
                        </div>
                        <small class="hint-text">ä¸Šå‚³åœ–ç‰‡å¾Œï¼ŒAI å°‡åˆ†æåœ–ç‰‡ä¸»è¦è‰²èª¿ã€æ§‹åœ–èˆ‡å°ºå¯¸ï¼Œä¸¦æŠŠè¦–è¦ºé¢¨æ ¼ç´å…¥è¡Œç¨‹å»ºè­°ã€‚</small>
                    </div>
                </div>
            </div>
            <div class="itinerary-actions" id="itineraryActions"
                style="display:none; margin-top:20px; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-secondary" id="openDownloadSheet" title="ä¸‹è¼‰è¡Œç¨‹">ä¸‹è¼‰è¡Œç¨‹</button>
                <button class="btn btn-secondary" id="transportBtn" title="æŸ¥çœ‹äº¤é€šè¦åŠƒå»ºè­°">ğŸš— äº¤é€šè¦åŠƒ</button>
            </div>
            <div id="suggestionContentWrapper">
                <div id="suggestionContent" class="ai-bubble" style="margin-top:20px;">
                    <p>é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI ç‚ºæ‚¨é‡èº«æ‰“é€ å°ˆå±¬è¡Œç¨‹ï¼</p>
                </div>
                <div id="itineraryCoverContainer" class="ai-bubble hidden" style="margin-top:20px; text-align:center;">
                    <img id="itineraryCoverImage" style="max-width:100%; border-radius:8px;" alt="è¡Œç¨‹å°é¢" />
                    <div class="download-controls"></div>

                </div>
                <button id="downloadTransportPdfBtn" class="btn hidden" style="margin-top: 12px;">ğŸ“„ ä¸‹è¼‰äº¤é€š PDF</button>
            </div>
        </section>

        <div class="content-area hidden" id="contentArea">
            <div class="description-panel panel fade-in">
                <h3>ğŸ“– æ™¯é»æ•…äº‹é›† (<span id="selectedDestinationName"></span>)</h3>
                <div class="accordion-content">
                    <div id="descriptionStoryWrapper" class="story-container">
                        <div id="descriptionContent" class="ai-bubble"></div>
                    </div>
                    <div id="attractionIllustrationContainer" class="ai-bubble hidden"
                        style="margin-top:20px; text-align:center;">
                        <img id="attractionIllustration"
                            style="max-width:100%; max-height:400px; border-radius:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" />
                    </div>
                    <div class="enhanced-ai-controls">
                        <button class="enhanced-btn" id="checklistBtn">ğŸ§³ è¡Œå›Šæº–å‚™æ¸…å–®</button>
                        <button class="enhanced-btn" id="cuisineBtn">ğŸ² åœ¨åœ°ç¾é£Ÿæ¨è–¦</button>
                        <button class="enhanced-btn" id="findHotelBtn">ğŸ¨ å°‹æ‰¾é™„è¿‘ä½å®¿</button>
                        <button class="enhanced-btn" id="reviewSummaryBtn">ğŸ“ ç¶²è·¯è©•è«–æ‘˜è¦</button>
                        <button class="enhanced-btn" id="souvenirBtn">ğŸ ä¼´æ‰‹ç¦®æ¨è–¦</button>
                    </div>
                    <!-- (å·²ç§»è‡³é€²éšè¨­å®š) åœ–ç‰‡ä¸Šå‚³æ§ä»¶ç¾åœ¨ä½æ–¼ã€Œé€²éšè¨­å®š (å¯é¸)ã€ä¸­ -->
                    <div id="aiCurrencyConverter" class="hidden"
                        style="margin-top: 20px; background: #f0f3e6; padding: 15px; border-radius: 8px;">
                        <p style="font-weight: 600; margin-bottom: 10px; color: var(--dark-text);">AI æ—…è²»ä¼°ç®—</p>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <input type="number" id="amountToConvert" class="api-input" placeholder="è¼¸å…¥é‡‘é¡ (TWD)"
                                style="flex: 1; min-width: 120px;">
                            <input type="text" id="targetCurrency" class="api-input" placeholder="ç›®æ¨™è²¨å¹£ (e.g., JPY)"
                                style="flex: 1; min-width: 120px;">
                        </div>
                        <button class="btn" id="convertCurrencyBtn"
                            style="background: var(--grass-green); color: white; width: 100%;">é–‹å§‹ä¼°ç®—</button>
                    </div>
                    <div id="aiEnhancedContent" class="ai-bubble hidden" style="margin-top: 20px;"></div>
                    <!-- å°ˆç”¨ï¼šåœ¨åœ°ç¾é£Ÿæ¨è–¦å®¹å™¨ï¼ˆMarkdown æœƒè¢«è½‰æˆ HTML ä¸¦å¥—ç”¨ .food-spots-listï¼‰ -->
                    <div id="foodSpotsContainer" class="ai-bubble hidden" style="margin-top: 20px;"></div>
                    <div id="reviewSummaryContent" class="ai-bubble hidden" style="margin-top:12px;"></div>
                    <div id="souvenirContent" class="ai-bubble hidden" style="margin-top:12px;"></div>
                    <div id="ttsPlayerContainer" class="ai-bubble hidden"
                        style="margin-top: 12px; padding: 12px; display:flex; flex-direction:column; gap:8px;">
                        <!-- Audio player will be injected here by JS -->
                        <audio id="ttsAudio" controls style="width:100%; display:none;"></audio>
                        <div id="ttsTranscript" style="font-size:0.95rem; color:var(--dark-text); display:none;"></div>
                    </div>
                </div>
            </div>
            <div class="map-panel panel fade-in">
                <h3>ğŸ—ºï¸ åœ°åœ–èˆ‡æ”å½±é»</h3>
                <div class="accordion-content">
                    <div id="map"></div>
                    <div id="imageGallery"></div>
                    <div class="enhanced-ai-controls" style="grid-template-columns: 1fr;">
                        <button class="enhanced-btn" id="photoSpotBtn">ğŸ“¸ AI æ¨è–¦æ”å½±é»</button>
                    </div>
                    <div id="aiPhotoSpotContent" class="ai-bubble photo-spots-markdown-container hidden"
                        style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <!-- Leaflet Routing Machine (for route calculation) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
    <!-- Leaflet Heatmap plugin -->
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <!-- Optionally include OSRM routing backend usage via LRM (no API key required; demo server) -->
    <!-- Custom JS Modules -->
    <!-- ç‰ˆæœ¬æ­·å²åŠŸèƒ½æ¨¡çµ„ -->
    <script type="module">
        import { initVersionHistoryUI } from './js/version-history-ui.js';
        import { saveItineraryVersion } from './js/version-history.js';

        // ç­‰å¾… DOM è¼‰å…¥å®Œæˆ
        window.addEventListener('DOMContentLoaded', () => {
            // å»¶é²åˆå§‹åŒ–ï¼Œç¢ºä¿å…¶ä»–å…ƒç´ å·²è¼‰å…¥
            setTimeout(() => {
                try {
                    initVersionHistoryUI();
                    console.log('âœ… Version history UI initialized');
                } catch (error) {
                    console.error('âŒ Failed to initialize version history UI:', error);
                }
            }, 500);
        });

        // æš´éœ²å‡½æ•¸çµ¦å…¨åŸŸä½¿ç”¨
        window.saveItineraryVersion = saveItineraryVersion;
    </script>
    <script type="module" src="js/main.js"></script>
    <script>
        // Utility to enable and focus the destination search input.
        (function () {
            function enableSearch(focus = true) {
                const el = document.getElementById('destinationSearch');
                if (!el) return false;
                el.classList.remove('hidden');
                el.disabled = false;
                if (focus) {
                    try { el.focus(); el.select(); } catch (e) { }
                }
                return true;
            }
            // Expose for console or other modules
            window.enableSearch = enableSearch;

            // Keyboard shortcut: '/' focuses search when not typing
            document.addEventListener('keydown', function (e) {
                if (e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey) {
                    const active = document.activeElement;
                    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return;
                    const ok = enableSearch(true);
                    if (ok) e.preventDefault();
                }
            });

            // Auto-enable when URL contains ?search=1
            try {
                if (new URLSearchParams(location.search).get('search') === '1') enableSearch(false);
            } catch (e) { }
        })();
    </script>
    <script>
        // Budget slider and select sync
        (function () {
            document.addEventListener('DOMContentLoaded', function () {

                // Budget slider <-> select sync
                const slider = document.getElementById('budgetSlider');
                const select = document.getElementById('budgetSelect');
                if (slider && select) {
                    const mapValToOption = ['low', 'medium', 'high'];
                    slider.addEventListener('input', function () { select.value = mapValToOption[Number(slider.value)]; });
                    select.addEventListener('change', function () { slider.value = mapValToOption.indexOf(select.value); });
                }
            });
        })();
    </script>
    <!-- Left circular navigation (desktop+mobile) -->
    <nav id="leftCircleNav" class="left-circle-nav" aria-label="å¿«é€ŸåŠŸèƒ½é¸å–®">
        <button class="circle-toggle" id="circleToggle" aria-expanded="false" aria-label="é–‹å•ŸåŠŸèƒ½é¸å–®">â˜°</button>
        <ul class="circle-menu" id="circleMenu" aria-hidden="true">
            <li><button class="circle-item" data-target="destinations" title="å‰å¾€æ™¯é»æ¸…å–®">ğŸ“</button></li>
            <li><button class="circle-item" data-target="contentArea" title="å‰å¾€è¡Œç¨‹/åœ°åœ–">ğŸ—ºï¸</button></li>
            <li><button class="circle-item" data-target="descriptionContent" title="å‰å¾€æ™¯é»æ•…äº‹">ğŸ“–</button></li>
            <li><button class="circle-item" data-target="favoritesModal" title="æˆ‘çš„æ”¶è— (é–‹å•Ÿ)">â¤ï¸</button></li>
        </ul>
    </nav>

    <!-- Right quick-jump buttons (top / bottom) -->
    <div id="quickJumpButtons" class="quick-jump-buttons" aria-hidden="false">
        <button id="jumpTopBtn" class="quick-jump" title="å›åˆ°é é¢é ‚éƒ¨">â†‘</button>
        <button id="jumpBottomBtn" class="quick-jump" title="å›åˆ°é é¢åº•éƒ¨">â†“</button>
    </div>

    <!-- Add Custom Spot Modal -->
    <div id="addCustomSpotModal" class="modal-overlay hidden" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="addCustomSpotTitle"
            style="max-width:700px;">
            <button id="closeAddSpotModal" class="modal-close-btn">&times;</button>
            <h3 id="addCustomSpotTitle" data-i18n="add_custom_spot_title">ï¼‹ æ–°å¢è‡ªè¨‚æ™¯é»</h3>
            <form id="addCustomSpotForm">
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <input id="customSpotName" class="api-input" data-i18n-placeholder="custom_spot_name_placeholder"
                        placeholder="æ™¯é»åç¨±" required style="flex:1;" />
                    <input id="customSpotCity" class="api-input" data-i18n-placeholder="custom_spot_city_placeholder"
                        placeholder="åŸå¸‚ (é¸å¡«)" style="width:180px;" />
                </div>
                <div style="margin-bottom:8px;">
                    <input id="customSpotImage" class="api-input" data-i18n-placeholder="custom_spot_image_placeholder"
                        placeholder="åœ–ç‰‡ URL (é¸å¡«)" style="width:100%;" />
                </div>
                <div style="margin-bottom:12px;">
                    <textarea id="customSpotDesc" class="api-input" data-i18n-placeholder="custom_spot_desc_placeholder"
                        placeholder="ç°¡çŸ­æè¿° (é¸å¡«)" style="width:100%; min-height:120px;"></textarea>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button type="button" id="cancelAddSpot" class="btn" data-i18n="cancel_button">å–æ¶ˆ</button>
                    <button type="submit" id="submitAddSpot" class="btn c-btn--primary"
                        data-i18n="add_spot_button">æ–°å¢æ™¯é»</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸‹è¼‰è¡Œç¨‹åº•éƒ¨å½ˆçª— -->
    <div id="downloadBackdrop" class="download-backdrop" style="display:none;"></div>
    <div id="downloadBottomSheet" class="download-bottom-sheet">
        <div class="bottom-sheet-header">
            <h4>ğŸ“¥ ä¸‹è¼‰è¡Œç¨‹</h4>
            <button id="closeBottomSheetBtn" class="bottom-sheet-close" aria-label="é—œé–‰">âœ•</button>
        </div>
        <div class="bottom-sheet-content">
            <button class="download-option" data-format="pdf">
                <span>ğŸ“„</span>
                <span>PDF æ–‡ä»¶</span>
            </button>
            <button class="download-option" data-format="ics">
                <span>ğŸ“…</span>
                <span>iCalendar (.ics)</span>
            </button>
            <button class="download-option" data-format="csv">
                <span>ğŸ“Š</span>
                <span>CSV è©¦ç®—è¡¨</span>
            </button>
            <button class="download-option" data-format="text">
                <span>ğŸ“</span>
                <span>ç´”æ–‡å­—</span>
            </button>
        </div>
    </div>

    <!-- i18n Injector Script - è‡ªå‹•æ³¨å…¥ç¿»è­¯å±¬æ€§ -->
    <script src="js/i18n-injector.js"></script>
    <script type="module" src="js/button-fix.js"></script>
    <!-- æŒ‰éˆ•å°é½Šè…³æœ¬ -->
    <script src="js/align-buttons.js"></script>

</body>

</html>